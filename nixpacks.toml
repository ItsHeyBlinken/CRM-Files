# Nixpacks Configuration for Event Planner CRM
# This file configures the Nixpacks build process for deployment

# Specify Node.js version (use 20 to avoid EOL warning)
[variables]
NIXPACKS_NODE_VERSION = '20'

# Setup phase: Install additional packages if needed
[phases.setup]
nixPkgs = ['...']

# Install phase: Install all dependencies (including devDependencies for TypeScript)
[phases.install]
cmds = [
  'echo "=== Installing dependencies ==="',
  'npm ci',
  'cd /app/server && npm install',
  'cd /app/client && npm install',
  'echo "=== Dependencies installed ==="'
]

# Build phase: Build both client and server
# Build client first, then server
[phases.build]
cmds = [
  'echo "=== Building Client ==="',
  'cd /app/client && npm run build',
  'echo "=== Client build complete ==="',
  'ls -la /app/client/dist/ | head -5',
  'echo "=== Building Server ==="',
  'cd /app/server && npm run build',
  'echo "=== Server build complete ==="',
  'ls -la /app/server/dist/ | head -10',
  'echo "=== Verifying builds ==="',
  'test -f /app/server/dist/index.js && echo "SUCCESS: server/dist/index.js exists" || echo "ERROR: server/dist/index.js missing"',
  'echo "=== Build verification complete ==="',
  'grep -r "fonts.googleapis.com" /app/server/dist/index.js && echo "CSP includes fonts.googleapis.com" || echo "WARNING: CSP may not be updated"',
  'grep -r "trust proxy" /app/server/dist/index.js && echo "Trust proxy found" || echo "WARNING: Trust proxy may not be set"'
]

# Start phase: Start the server
[start]
cmd = 'cd /app/server && node dist/index.js'

# Environment variables (can be overridden by VPS settings)
[env]
NODE_ENV = 'production'

